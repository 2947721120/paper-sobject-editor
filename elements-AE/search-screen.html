<link rel="import" href="../dependencies/core-scroll-header-panel/core-scroll-header-panel.html">
<link rel="import" href="../dependencies/core-toolbar/core-toolbar.html">
<link rel="import" href="../dependencies/core-icon-button/core-icon-button.html">
<link rel="import" href="../dependencies/core-list/core-list.html">
<polymer-element name="search-screen" extends="force-route" attributes="sobject searchfields fieldstofetch resultHeight">
    <template>

        <style>
            force-ui-search /deep/ paper-input::shadow #floatedLabel {
                display: none;
            }
            force-ui-search /deep/ paper-input::shadow #errorContainer {
                display: none;
            }
            force-ui-search /deep/ #underline>div {
                background-color: white
            }
            force-ui-search /deep/ .cursor {
                background-color: white
            }
            force-ui-search /deep/ input {
                color: white;
            }

            core-scroll-header-panel {
                position: absolute;
                top: 0; bottom: 0;
                left: 0; right: 0;
            }

            :host /deep/ core-icon {
                fill: #fff;
            }

            /* background for toolbar when it is at its full size */
            core-scroll-header-panel::shadow #headerBg {
                background-image: url(banner.jpg);
            }

            /* background for toolbar when it is condensed */
            core-scroll-header-panel::shadow #condensedHeaderBg {
                background-color: #00adef;
            }

            core-toolbar {
                color: #f1f1f1;
                fill: #f1f1f1;
                background-color: transparent;
            }

            .title {
                font-size: 40px;
            }
            .content {
                padding: 10px 0px;
            }

            #scrollHeader::shadow #headerContainer {
                transition: transform 200ms ease-out;
                -webkit-transition: -webkit-transform 200ms ease-out;
            }

            #scrollHeader::shadow #mainContainer {
                overflow: hidden;
            }

        </style>

        <core-scroll-header-panel id="scrollHeader" condenses style="-webkit-overflow-scrolling: touch; overflow: hidden;">
        	
            <paper-shadow></paper-shadow>
            <core-toolbar id="toolbar" class="tall paper-shadow-top paper-shadow-top-z-1">
    
                <core-icon id="search-icon" icon="search"></core-icon>
                <div flex>
                    <force-ui-search id="search" sobject="{{sobject}}" searchfields="{{searchfields}}" fieldstofetch="{{fieldstofetch}}" cachemode="{{cachemode}}"></force-ui-search>
                </div>
                <core-icon id="create-icon" icon="add" on-tap="{{navigateToCreate}}"></core-icon>
                <div id="title" class="bottom indent title">{{$.list.models.length || ""}} Contacts</div>
		      
            </core-toolbar>

            <div class="content" style="height:100%">
                <img id="loading" src="loading-gray.gif" style="position: absolute; top: 50%; left: 45%; width: 32px;"/>
                <force-sobject-sync sobject="{{sobject}}" fieldstoindex="{{searchfields}}" query="{{syncQuery}}" on-syncdown="{{showSearch}}"></force-sobject-sync>
                <force-sobject-collection id="list" sobject="{{sobject}}" querytype="{{$.search.querytype}}" query="{{$.search.query}}" style="display:none" maxsize="2000" pagesize="100" autosync="false"></force-sobject-collection>
                <core-list id="uilist" height="{{resultHeight}}" style="height:100%" data="{{$.list.models}}">
                    <content select="*"></content>
                </core-list>

            </div>

        </core-scroll-header-panel>

    </template>
    <script>
    	(function() {
	        var titleStyle;

	        Polymer('search-screen', {
              cachemode: Force.CACHE_MODE.CACHE_ONLY,
	          ready: function() {
	            this.super();
                this.setupSyncQuery();
	            titleStyle = this.$.title.style;
                this.addEventListener('core-header-transform', this.titleTransform.bind(this), false);
                this.$.uilist.addEventListener('scroll', this.toggleHeader.bind(this));
	          },

              toggleHeader: function(e) {
                this._scrollTop = e.detail ? e.detail.target.scrollTop : e.target.scrollTop;
                if (this._scrollTop > 0 && !this.condensed) {
                    this.$.scrollHeader.transformHeader(this.$.scrollHeader.headerMargin);
                    this.$.scrollHeader.$.mainContainer.style.paddingTop = (this.$.scrollHeader.headerHeight - this.$.scrollHeader.headerMargin) + 'px';
                    titleStyle.display = 'none';
                    this.condensed = true;
                } else if (this._scrollTop == 0 && this.condensed) {
                    this.$.scrollHeader.setup();
                    titleStyle.display = 'block';
                    this.condensed = false;
                }
              },

              setupSyncQuery: function() {
                var searchFields = this.searchfields.trim().split(/\s+/);
                var fieldsToFetch = this.fieldstofetch ? this.fieldstofetch.trim().split(/\s+/) : [];
                fieldsToFetch = _.union(searchFields, fieldsToFetch);

                this.syncQuery = "SELECT Id, " + fieldsToFetch.join(',') + " FROM " + this.sobject + " LIMIT 4000";
              },

              showSearch: function() {
                this.$.loading.style.display = "none";
                this.$.list.autosync = true;
                this.$.list.fetch();
              },

              attached: function() {
                this.$.uilist.appendChild(this.querySelector('template'));
              },              

	          updateConnection: function() {
	            this.$.search.computeQuery();
	          },

	          refresh: function() {
	            this.$.list.fetch();
	          },

	          navigateToCreate: function() {
	            window.location.hash = "#edit";
	          },

	          titleTransform: function(e) {
	              var d = e.detail;
	              var m = d.height - d.condensedHeight;
	              var scale = Math.max(0.75, (m - d.y) / (m / 0.25)  + 0.75);
	              titleStyle.webkitTransform = titleStyle.transform = 
	                  'scale(' + scale + ') translateZ(0)';
	          }
	        });
		})();
    </script>
</polymer-element>

