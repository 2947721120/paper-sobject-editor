<dom-module id="sync-status-icon" attributes="recordid, failedids">
    <template>
        <template if="{{failed}}">
            <iron-icon icon="error" style="fill: red"></iron-icon>
        </template>
    </template>
    <script>
        Polymer({
            is: 'sync-status-icon',
            get failed() {
                return _.contains(this.failedids, this.recordid);
            }
        })
    </script>
</dom-module>

<dom-module id="sync-screen" on-route-changed="viewLoaded">
    <style>
        :host /deep/ iron-icon {
            color: #fff;
            width: 40px; 
            height: 40px;
        }
    </style>
    <template>
        <paper-material>

            <paper-toolbar id="toolbar">
              <iron-icon id="back-icon" icon="chevron-left" on-tap="navigateBack" style="width: 45px; height: 45px; margin: -5px;" on-touchend="stopClick"></iron-icon>
              <div flex></div>
              <div on-tap="doSync" style="color:white; line-height: 50px; width: 80px;" layout horizontal end-justified>Sync</div>
            </paper-toolbar>

        </paper-material>

        <div style="position: absolute; top: 64px; bottom: 0; right: 0; left: 0; overflow-y: scroll; -webkit-overflow-scrolling: touch;">
            
            <force-sobject-collection id="list" sobject="{{sobject}}" querytype="cache" query="{{query}}" collection="{{collection}}" on-sync="syncComplete"></force-sobject-collection>
            <div id="listview">
                <template is="dom-repeat" items="[[collection.models]]">
                    <a href="#edit/{{item.id}}/sync" style="text-decoration: none; color: inherit">
                        <div style="line-height: 20px; padding: 10px; border-bottom: 1px solid rgb(221, 221, 221);">
                            <div horizontal layout>
                                <status-icon props="{{item.attributes}}"></status-icon>
                                <sync-status-icon recordid="{{item.id}}" failedids="{{failedIds}}"></sync-status-icon>
                                <div flex style="margin-left: 10px">{{item.attributes.Name || (item.attributes.FirstName + ' ' + item.attributes.LastName)}}</div>
                                <iron-icon icon="chevron-right" style="fill: black"></iron-icon>
                            </div>
                        </div>
                    </a>
                    <force-sobject sobject="{{sobject}}" recordid="{{item.id}}" mergemode="{{mergemode}}"></force-sobject>
                </template>
            </div>
        </div>
    </template>
    <script type="text/javascript">
    Polymer({
        is: 'sync-screen', 
        properties: {
            sobject: String,
            failedIds: {
                type: Array,
                value: function() { return []; },
                notify: true
            },
            query: {
                type: Object,
                value: {queryType:"exact", indexPath:"__local__", matchKey:true, order:"ascending", pageSize:25}
            }
        },
        behaviors: [SFDC.RoutingBehavior],
        get mergemode() {
            return Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED;
        },

        stopClick: function(e) {
            e.preventDefault();
        },

        refresh: function() {
            this.$.list.fetch();
        },

        hasLocalChanges: function() {
            return this.$.list.collection.length > 0;
        },

        doSync: function() {
            var that = this;
            var sobjects = Polymer.dom(this.$.listview).querySelectorAll('force-sobject');
            var syncStatuses = [];

            this.failedIds = [];
            var saveOptions = function(deferred) {
                return {
                    cacheMode: Force.CACHE_MODE.SERVER_FIRST,
                    success: function() {
                        that.$.list.fetch();
                        that.fire('item-synced');
                        deferred.resolve();
                    },
                    error: function(model) {
                        that.failedIds.push(model.id);
                        that.$.list.fetch();
                        deferred.resolve();
                    }
                }
            }

            _.each(sobjects, function(sobject) {
                var statusDeferred = $.Deferred();
                var options = saveOptions(statusDeferred);

                if (sobject.fields['__locally_deleted__'])
                    sobject.destroy(options);
                else sobject.save(options);

                //Track save status and fire a complete event when all saves are finished
                syncStatuses.push(statusDeferred.promise());
            });

            return $.when.apply($, syncStatuses).then(function() {
                that.fire('sync-complete');
            });
        },

        navigateBack: function() {
            window.history.back();
        },

        syncComplete: function() {
            if (!this.hasLocalChanges() && this.path == Backbone.history.fragment) this.navigateBack();
        },

        viewLoaded: function() {
            if (!this.hasLocalChanges()) this.navigateBack();  
        }
    });
    </script>
</dom-module>
